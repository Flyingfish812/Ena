# 数学指导手册（Scale-aware Evaluation）

---

## 0. 导言：科研问题与尺度判据的澄清（必读）

### 0.1 本项目真正要回答的科研问题

本项目中的多尺度评估 **并非** 旨在回答：

> “模型在某个尺度上的误差是否更小？”

而是试图回答一个**更具物理意义、也更可迁移的问题**：

> **在给定观测稀疏度 $p$ 与噪声水平 $\sigma$ 的条件下，模型在频域上能够可靠重构的最大空间波数（或等价地，最小空间尺度）是多少？**

等价表述包括：

* 模型在逐步引入更小空间尺度（更高波数）信息时，
  **在哪一尺度之后，其预测结果不再携带可区分于噪声的物理结构信息**；
* 模型的预测在哪些尺度上仍然：

  * 与真实场保持**结构一致性**；
  * 不表现为纯统计噪声或平滑残余；
* 是否可以定义一个**有效可恢复尺度上界**，用于：

  * 模型能力对比；
  * 参数扫描（$p,\sigma$）下的尺度退化分析；
  * 后续物理分析中的自适应尺度裁切。

因此，本项目的核心目标是定义并验证一个 **“有效可恢复尺度（effective recoverable scale）”**，而不是单纯比较误差大小。

---

### 0.2 关于误差型指标的定位（重要声明）

在整个评估体系中：

* **误差幅值类指标**（如 NMSE / NRMSE / PSNR）
  **仅作为诊断量（diagnostic quantities）存在**；
* 它们**不作为定义“可恢复尺度”的主判据**。

原因在于：

* 在高频或小尺度区域，误差可能因能量衰减而“数值上变小”，
  但预测结果在结构上已完全不可解释；
* 单一误差指标无法区分：

  * “结构正确但幅值偏差”
  * 与“结构已丢失，仅剩噪声或归纳偏置产物”。

因此，本项目采用**结构一致性与频域统计量**作为尺度判定的核心。

---

## 1. 数据表示与重建模型（统一背景）

本节给出 **线性基线与 MLP 基线共享的数学背景**，后续所有尺度分析均基于这一统一表示。

---

### 1.1 原始数据与向量化表示

对每个时间帧 $t=1,\dots,T$，原始场为
$$
X_t \in \mathbb{R}^{H\times W\times C}.
$$

通过展平算子 $\mathrm{vec}(\cdot)$，得到向量表示：
$$
x_t = \mathrm{vec}(X_t) \in \mathbb{R}^{D}, \qquad D = HWC.
$$

定义样本矩阵（每个样本作为一行）：
$$
\mathbf{X}
=

\begin{bmatrix}
x_1^\top \
\vdots \
x_T^\top
\end{bmatrix}
\in \mathbb{R}^{T\times D}.
$$

---

### 1.2 POD 基底与低维表示

令 $\mu\in\mathbb{R}^D$ 为样本均值（是否去均值取决于具体实验设置），
定义中心化样本：
$$
\tilde x_t = x_t - \mu.
$$

对中心化样本矩阵 $\tilde{\mathbf{X}}$ 进行 POD（等价于 SVD 或协方差特征分解），得到正交基：
$$
U = [u_1,u_2,\dots,u_D] \in \mathbb{R}^{D\times D}, \qquad U^\top U = I.
$$

取前 $r$ 个模态作为截断基：
$$
U_r = [u_1,\dots,u_r] \in \mathbb{R}^{D\times r}.
$$

在该子空间中，场的近似表示为：
$$
x_t \approx \mu + U_r a_t, \qquad a_t \in \mathbb{R}^r.
$$

真实 POD 系数（正交投影）定义为：
$$
a_t^\star = U_r^\top (x_t - \mu).
$$

---

### 1.3 稀疏观测模型（采样算子）

在空间网格上随机选择观测点集合 $\Omega \subset {1,\dots,D}$，
其大小为 $M = |\Omega| \ll D$。

用选择矩阵（采样算子）表示为：
$$
S \in {0,1}^{M\times D},
$$
使得无噪声观测为：
$$
y_t = S x_t \in \mathbb{R}^M.
$$

加入独立同分布高斯噪声：
$$
\varepsilon_t \sim \mathcal{N}(0,\sigma^2 I_M),
$$
得到带噪观测：
$$
\tilde y_t = S x_t + \varepsilon_t.
$$

---

### 1.4 两类重建模型（统一输出形式）

无论使用哪种模型，其最终输出形式均为：

* **预测 POD 系数** $\hat a_t \in \mathbb{R}^r$；
* **重建场**
  $$
  \hat x_t = \mu + U_r \hat a_t.
  $$

区别仅在于 $\hat a_t$ 的获得方式：

* **线性基线**：
  通过最小二乘从 $(S U_r)a_t \approx \tilde y_t - S\mu$ 反演；
* **MLP 基线**：
  通过学习映射 $f_\theta:\mathbb{R}^M\to\mathbb{R}^r$ 预测系数。

这一统一形式确保：
**后续所有尺度分析仅依赖于 $(x_t,\hat x_t)$，与模型内部实现解耦。**

---

# 2. 传统误差型多尺度评估（历史方案，诊断用途）

> **本章中的指标在早期版本中被用于探索“多尺度误差行为”，
> 但已通过系统实验验证：它们不足以单独回答“模型的有效可恢复尺度”问题。
> 因此，本章内容予以保留，仅作为辅助诊断与历史对照。**

---

## 2.1 场空间误差指标（整体性能）

对任一重建结果 $\hat x_t$ 与真实场 $x_t$，定义误差向量：
$$
e_t = \hat x_t - x_t.
$$

常用场级误差指标包括：

* **MSE**
  $$
  \mathrm{MSE} = \frac{1}{D}|e_t|_2^2.
  $$

* **RMSE**
  $$
  \mathrm{RMSE} = \sqrt{\mathrm{MSE}}.
  $$

* **NMSE**
  $$
  \mathrm{NMSE} = \frac{|e_t|_2^2}{|x_t|_2^2}.
  $$

* **NMAE**
  $$
  \mathrm{NMAE} = \frac{|e_t|_1/D}{|x_t|_1/D}.
  $$

* **PSNR**（给定数据动态范围 $R$）
  $$
  \mathrm{PSNR} = 10\log_{10}\frac{R^2}{\mathrm{MSE}}.
  $$

对时间维 $t=1,\dots,T$，可对上述指标取均值或中位数，用于汇总模型整体性能。

---

### 【局限性说明】

这些指标：

* 是**全尺度混合**的；
* 对高频误差的结构性质不敏感；
* 容易被大尺度能量主导。

因此：

> **即便两个模型在 NMSE 上相近，它们在“能否恢复小尺度结构”这一问题上的能力可能完全不同。**

---

## 2.2 系数空间误差：逐模态 RMSE / NRMSE

在 POD 系数空间中，定义预测误差：
$$
\delta a_{t,k} = \hat a_{t,k} - a_{t,k}^\star.
$$

逐模态 RMSE 定义为：
$$
\mathrm{RMSE}_k
=

\sqrt{
\frac{1}{T}
\sum_{t=1}^T
(\delta a_{t,k})^2
}.
$$

逐模态 NRMSE 可通过以下方式归一化：

* **基于 POD 特征值 $\lambda_k$**
  $$
  \mathrm{NRMSE}_k = \frac{\mathrm{RMSE}_k}{\sqrt{\lambda_k}}.
  $$

* **基于真实系数时间标准差**
  $$
  \mathrm{NRMSE}_k
  =

  \frac{\mathrm{RMSE}_k}{\max(\mathrm{std}*t(a*{t,k}^\star),\varepsilon)}.
  $$

---

### 【局限性说明】

* POD 模态索引 $k$ **不等价于严格的物理尺度**；
* 不同模态之间的空间频率支撑存在显著重叠；
* 高阶模态误差变小，可能仅因其能量本身极低。

因此：

> **逐模态误差无法稳定地映射到“可恢复空间尺度”。**

---

## 2.3 按模态分组（band）的误差统计

给定一组模态分段：
$$
\mathcal{B} = { [s_b,e_b) }_{b=1}^B,
$$
定义每个 band 的 NRMSE：
$$
\mathrm{NRMSE}_b
=

\sqrt{
\frac{
\sum_{t=1}^T \sum_{k\in b} (\delta a_{t,k})^2
}{
\sum_{t=1}^T \sum_{k\in b} (a_{t,k}^\star)^2
}
}.
$$

---

### 【历史用途】

该指标在早期用于：

* 粗略比较“低 / 中 / 高阶模态”的重建难度；
* 定性观察误差随模态序号的增长趋势。

---

### 【已验证的不足】

* band 边界人为；
* 与真实空间尺度的映射不唯一；
* 难以跨数据集或网格复用。

因此，该方法**不再作为核心尺度判据**。

---

## 2.4 部分重建（single-group / cumulative）误差

构造仅使用部分模态的重建：

* 单组：
  $$
  a^{(g)}*{t,k} =
  \begin{cases}
  a*{t,k}, & k\in G_g,\
  0, & \text{otherwise},
  \end{cases}
  $$

* 累积：
  $$
  a^{(\le g)}*{t,k} =
  \begin{cases}
  a*{t,k}, & k\in \cup_{j\le g}G_j,\
  0, & \text{otherwise}.
  \end{cases}
  $$

对应重建场：
$$
x_t^{(g)} = \mu + U_r a_t^{(g)},\qquad
x_t^{(\le g)} = \mu + U_r a_t^{(\le g)}.
$$

定义场空间 NMSE：
$$
\mathrm{NMSE}^{(g)}
=

\frac{|x^{(g)}*{\text{hat}}-x^{(g)}*{\text{true}}|*2^2}
{|x^{(g)}*{\text{true}}|_2^2+\varepsilon}.
$$

---

### 【历史结论】

该方法**在定性层面**能展示：

* 误差随“引入更多模态”而变化的趋势；
* 累积误差的饱和现象。

---

### 【核心问题】

> **“模态累积饱和” ≠ “物理尺度恢复完成”。**

因此，本方法仅作为**辅助可视化**保留。

---

# 3. 频域表示与物理尺度标定（基础工具）

> **本章是 scale 指标的数学基础，不直接给出判据，但不可省略。**

---

## 3.1 二维离散傅里叶变换（FFT）

对二维场 $x_t(i,j)$，定义离散傅里叶变换：
$$
\hat x_t(p,q)
=

\sum_{i=0}^{N_x-1}
\sum_{j=0}^{N_y-1}
x_t(i,j)
\exp\left[
-2\pi i\left(
\frac{pi}{N_x}+\frac{qj}{N_y}
\right)
\right].
$$

预测场与误差场的傅里叶谱分别为：
$$
\widehat{\hat x}_t(p,q),\qquad
\hat e_t(p,q)=\widehat{\hat x}_t(p,q)-\hat x_t(p,q).
$$

---

## 3.2 波数网格与物理尺度

定义整数频率索引：
$$
\tilde p =
\begin{cases}
p, & p\le N_x/2,\
p-N_x, & p>N_x/2,
\end{cases}
\qquad
\tilde q =
\begin{cases}
q, & q\le N_y/2,\
q-N_y, & q>N_y/2.
\end{cases}
$$

物理波数：
$$
k_x = \frac{2\pi}{L_x}\tilde p,\qquad
k_y = \frac{2\pi}{L_y}\tilde q,
$$
$$
k = \sqrt{k_x^2 + k_y^2}.
$$

对应波长：
$$
\lambda = \frac{2\pi}{k},\qquad k>0.
$$

---

## 3.3 物理尺度归一化

以圆柱直径 $D$ 作为特征长度：
$$
s = \frac{\lambda}{D}.
$$

Nyquist 限制下的最小可分辨尺度：
$$
\lambda_{\min} \approx 2\max(\Delta x,\Delta y),
\qquad
s_{\min}=\frac{\lambda_{\min}}{D}.
$$

---

# 4. 频域统计量的统一定义（Scale Analysis 的核心对象）

> **从本章开始，评估范式正式从“误差”转向“结构与统计一致性”。**

---

## 4.1 频域功率谱与交叉谱

对单帧定义：

* 真值功率谱：
  $$
  P_{\text{true}}(p,q) = |\hat x_t(p,q)|^2.
  $$

* 预测功率谱：
  $$
  P_{\text{pred}}(p,q) = |\widehat{\hat x}_t(p,q)|^2.
  $$

* 交叉谱：
  $$
  C_{tp}(p,q) = \widehat{\hat x}_t(p,q),\overline{\hat x_t(p,q)}.
  $$

---

## 4.2 径向平均（从 2D 到 1D）

对波数模长做径向分箱：
$$
\Omega_m = {(p,q): k(p,q)\in[k_m,k_{m+1})}.
$$

定义径向平均功率谱：
$$
P_{\text{true}}(k_m)
=

\frac{1}{T}
\sum_{t=1}^T
\frac{1}{|\Omega_m|}
\sum_{(p,q)\in\Omega_m}
P_{\text{true}}(p,q),
$$
其余量类似。

---

# 5. 结构一致性指标（Structural Consistency）

> **本章指标用于判断：在给定空间尺度上，预测结果是否仍携带与真实场一致的结构信息。**
> 这些指标不以误差幅值为核心，而关注频域中的相关性与统计一致性。

---

## 5.1 相关系数 $\rho(k)$（结构相似性）

### 数学定义

基于径向平均后的频域统计量，定义：

$$
\rho(k)
=

\frac{
\operatorname{Re}, C_{tp}(k)
}{
\sqrt{
P_{\text{true}}(k) \cdot P_{\text{pred}}(k)
}
+\varepsilon
}.
$$

其中：

* $C_{tp}(k)$ 为交叉谱的径向平均；
* $P_{\text{true}}(k)$、$P_{\text{pred}}(k)$ 分别为真值与预测功率谱；
* $\varepsilon$ 为数值稳定项。

理论取值范围为：
$$
-1 \le \rho(k) \le 1.
$$

---

### 物理与统计含义

$\rho(k)$ 衡量的是：

> **预测与真值在该尺度上的“相位 + 结构”一致性**

其特点是：

* 对幅值整体缩放不敏感；
* 对相位错位高度敏感；
* 能有效识别“形状是否相同”。

---

### 判据角色与局限性

* ✔ 能判断结构是否一致；
* ✘ 不能区分“幅值严重失真但结构尚存”的情况；
* ✘ 在低能量频段可能受数值噪声影响。

因此：

> **$\rho(k)$ 是结构恢复的必要条件，但不是充分条件。**

---

### 尺度阈值定义（辅助）

给定阈值 $\rho_{\text{th}}$（如 0.8），定义：

$$
k_{\text{eff}}^{(\rho)}
=

\max{k:\rho(k)\ge\rho_{\text{th}}}.
$$

该尺度反映：

> **模型在保持结构一致性的最大空间波数。**

---

## 5.2 频域相干性 $\mathrm{coherence}(k)$（统计一致性）

### 数学定义

定义谱相干性：

$$
\mathrm{coherence}(k)
=

\frac{
|C_{tp}(k)|^2
}{
P_{\text{true}}(k) \cdot P_{\text{pred}}(k)
+\varepsilon
},
\qquad
0\le \mathrm{coherence}(k)\le 1.
$$

---

### 含义说明

$\mathrm{coherence}(k)$ 描述的是：

> **预测在该尺度上能否被真实场“线性解释”的程度**

其本质是一个**统计稳定性指标**：

* 对噪声更鲁棒；
* 不直接反映相位方向；
* 对“相关但不准确”的预测仍可能给出较高值。

---

### 判据角色与局限性

* ✔ 适合用于统计意义下的尺度稳定性分析；
* ✔ 在多样本平均后表现稳定；
* ✘ 单独使用时，可能高估高频预测质量。

因此：

> **coherence 是尺度恢复的“统计必要条件”，但仍非充分条件。**

---

### 尺度阈值定义（常用）

给定阈值 $\mathrm{coh}_{\text{th}}$（如 0.5 或 0.8），定义：

$$
k_{\text{eff}}^{(\mathrm{coh})}
=

\max{k:\mathrm{coherence}(k)\ge \mathrm{coh}_{\text{th}}}.
$$

---

## 5.3 二维 $\rho$ / coherence 分布（机制诊断）

在二维波数平面 $(k_x,k_y)$ 上，可定义：

$$
\rho(k_x,k_y),\qquad
\mathrm{coherence}(k_x,k_y),
$$

并绘制对应热力图。

---

### 用途定位（非常重要）

> **2D 指标不用于定义 $k_{\text{eff}}$，而用于解释其“为何失效”。**

典型用途包括：

* 识别方向性伪影；
* 区分各向同性退化与轴向失稳；
* 揭示模型归纳偏置。

---

# 6. 幅值与能量诊断指标（Amplitude & Noise Diagnostics）

> **本章指标用于回答：即便结构仍相关，其幅值与能量是否仍然可信。**

---

## 6.1 幅值响应 $\mathrm{gain}(k)$

### 数学定义

定义幅值增益为：

$$
\mathrm{gain}(k)
=

\frac{
|C_{tp}(k)|
}{
P_{\text{true}}(k)
+\varepsilon
}.
$$

---

### 含义说明

$\mathrm{gain}(k)$ 衡量：

> **预测在该尺度上的能量幅值是否与真值匹配**

典型解释：

* $\mathrm{gain}\approx 1$：幅值保真；
* $\mathrm{gain}<1$：系统性低估（平滑化）；
* $\mathrm{gain}>1$：系统性放大（振铃、过拟合）。

---

### 判据定位

* ✔ 可识别“看起来相关，但幅值错误”的情况；
* ✘ 单独使用无法判断结构是否真实。

因此：

> **gain 是重要的幅值诊断量，而非独立尺度判据。**

---

## 6.2 信噪比 $\mathrm{SNR}(k)$

### 数学定义

定义径向能量信噪比：

$$
\mathrm{SNR}(k)
=

\frac{
P_{\text{true}}(k)
}{
P_{\text{err}}(k)
+\varepsilon
},
$$

其中误差谱：
$$
P_{\text{err}}(k)
=

|\hat e(k)|^2.
$$

通常使用对数形式：
$$
\log_{10}\mathrm{SNR}(k).
$$

---

### 含义说明

$\mathrm{SNR}(k)$ 回答：

> **在该尺度上，预测信号是否高于误差噪声背景**

常用经验阈值：

* $\log_{10}\mathrm{SNR}(k)\ge 0 \iff \mathrm{SNR}\ge 1$。

---

### 判据角色与局限性

* ✔ 可判断预测是否仍“有信号意义”；
* ✘ 不区分结构正确与否；
* ✘ 在低能量频段可能产生误判。

---

# 7. 综合尺度评分 $\mathrm{score}(k)$（最终判据）

> **本章给出“有效可恢复尺度”的统一判据。**

---

## 7.1 定义

定义综合尺度评分：

$$
\mathrm{score}(k)
=

\rho(k)\cdot
\exp\left(
-\left|\log \mathrm{gain}(k)\right|
\right).
$$

---

### 设计动机

该定义强制同时满足：

1. **结构一致性高**（$\rho(k)$ 大）；
2. **幅值不发生系统性失真**（$\mathrm{gain}(k)\approx 1$）。

任一条件不满足，$\mathrm{score}(k)$ 均会被显著压低。

---

## 7.2 有效可恢复尺度的定义（核心）

给定评分阈值 $\tau$（通常取 $\tau=0.8$），定义：

$$
k_{\text{eff}}
=

\max{k:\mathrm{score}(k)\ge\tau}.
$$

---

### 含义总结（推荐在汇报中使用）

> **$k_{\text{eff}}$ 是模型在给定实验条件下，
> 能够同时保持结构一致性与幅值可信性的最大空间波数。**

其倒数 $1/k_{\text{eff}}$ 对应最小可恢复物理尺度。

---

## 7.3 与其他尺度定义的关系

| 指标             | 是否充分  | 角色         |
| -------------- | ----- | ---------- |
| $\rho(k)$      | 否     | 结构必要条件     |
| coherence$(k)$ | 否     | 统计稳定性      |
| gain$(k)$      | 否     | 幅值诊断       |
| SNR$(k)$       | 否     | 噪声诊断       |
| **score$(k)$** | **是** | **统一尺度裁决** |

---

# 8. 有效可恢复尺度 $k_{\text{eff}}$ 的统一定义与使用规范

> **本章统一整理不同尺度定义的关系，并明确本项目采用的最终标准。**

---

## 8.1 多种 $k_{\text{eff}}$ 定义的来源

在不同分析阶段中，可以从不同指标定义尺度上界：

* 基于结构相关性：
  $$
  k_{\text{eff}}^{(\rho)}
  =

  \max{k:\rho(k)\ge\rho_{\text{th}}};
  $$

* 基于统计一致性：
  $$
  k_{\text{eff}}^{(\mathrm{coh})}
  =

  \max{k:\mathrm{coherence}(k)\ge\mathrm{coh}_{\text{th}}};
  $$

* 基于信噪判据：
  $$
  k_{\text{eff}}^{(\mathrm{SNR})}
  =

  \max{k:\log_{10}\mathrm{SNR}(k)\ge 0}.
  $$

这些定义分别反映了：

* 结构一致性；
* 统计稳定性；
* 能量是否高于噪声。

---

## 8.2 为何需要统一尺度判据

单一指标存在不可避免的歧义：

* $\rho(k)$ 高
  ⇏ 幅值可信；
* coherence$(k)$ 高
  ⇏ 结构正确；
* SNR$(k)$ 高
  ⇏ 预测不是系统性偏差。

因此，在实验中经常观察到：

> 不同 $k_{\text{eff}}$ 定义给出不一致甚至相互矛盾的尺度界限。

这在模型对比或参数扫描中将导致解释困难。

---

## 8.3 本项目采用的最终定义（推荐标准）

综合前述分析，本项目**统一采用基于综合评分的尺度定义**：

$$
k_{\text{eff}}
=

\max{k:\mathrm{score}(k)\ge\tau},
\qquad \tau=0.8.
$$

其中：
$$
\mathrm{score}(k)
=

\rho(k)\cdot
\exp\left(
-\left|\log \mathrm{gain}(k)\right|
\right).
$$

---

### 定义优势总结

该定义同时保证：

1. **结构一致性存在**（$\rho$）；
2. **幅值未发生系统性失真**（gain）；
3. **避免单一指标误判**。

因此：

> ** $k_{\text{eff}}$ 可以被解释为“模型在给定实验条件下的有效空间分辨率”。**

---

## 8.4 实际实验中的使用规范

在实际实验与汇报中，推荐遵循以下顺序：

1. **首先检查 2D 频域图**

   * $\rho(k_x,k_y)$
   * coherence$(k_x,k_y)$
     用于排除明显的方向性伪影或数值异常；

2. **再查看 1D 曲线**

   * $\rho(k)$、coherence$(k)$、gain$(k)$、SNR$(k)$；

3. **最后报告 $\mathrm{score}(k)$ 与 $k_{\text{eff}}$**
   作为定量结论。

---

# 9. 历史方案对照与弃用说明（方法演化记录）

> **本章用于记录方法演化路径，明确哪些方案已被验证为不足以回答核心科研问题。**

---

## 9.1 已弃用为“主判据”的方法（保留为诊断）

以下方法**不再作为定义有效可恢复尺度的依据**：

### 9.1.1 场空间 NMSE / RMSE

* 问题：

  * 多尺度混合；
  * 高频误差可能被低能量掩盖；
* 定位：

  * 整体性能评估；
  * 不具备尺度区分能力。

---

### 9.1.2 POD 模态序号作为尺度替代

* 问题：

  * 模态序号 $\neq$ 空间尺度；
  * 模态频谱支撑重叠严重；
* 定位：

  * 模型训练与数值稳定性分析。

---

### 9.1.3 band-wise NRMSE / cumulative error

* 问题：

  * band 边界人为；
  * 不可跨数据集复用；
* 定位：

  * 辅助可视化；
  * 历史对照。

---

## 9.2 为什么仍然保留这些方法

尽管上述方法无法单独回答核心科研问题，但它们在以下方面仍有价值：

* 辅助理解模型训练行为；
* 帮助排查数值异常；
* 与既有文献结果对照。

因此：

> **本手册保留这些方法，但明确其“非判据”定位，以避免误用。**

---

## 9.3 本手册的使用方式（给我看的）

本手册的定位是：

> **实验设计 → 结果解读 → 判据对照 的参考标准**

而非：

* 指标罗列手册；
* 或调参 checklist。

在新增实验或模型时，应始终回到第 0 章提出的问题：

> **“这个结果是否帮助我回答了：模型在哪些尺度上仍然可靠？”**

---

# 结语

通过引入基于频域结构一致性的尺度判据，本项目实现了：

* 从误差导向评估 → 物理尺度导向评估；
* 从单一指标 → 多条件联合判据；
* 从经验观察 → 可复现的尺度定义。

这为后续的模型比较、参数扫描以及物理解释提供了统一的评估基础。
